using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using OpenMcdf;
using System.Threading.Tasks;
using System.Text.RegularExpressions;
using System.IO;
using System.IO.Compression;
using Kavod.Vba.Compression;

namespace DocGuard_Audit
{
    public class DocGuard
    {

        // Name of the generated output file.
        static string outFilename = "";
        static string orgFilename = "";
        static string orgfileName = "";

        // Compound file that is under editing
        static CompoundFile cf;

        // Byte arrays for holding stream data of file
        static byte[] vbaProjectStream;
        static byte[] dirStream;
        static byte[] projectStream;

        static public bool Audit(string filename)
        {
            bool lastReport = false;

            bool findHideInGUI = true;

            bool findUnviewableVBA = true;

            bool findRandomName = true;

            bool findBlacklistApiUsage = true;

            bool is_OpenXML = false;

            // Temp path to unzip OpenXML files to
            String unzipTempPath = "";

            // OLE Filename (make a copy so we don't overwrite the original)
            outFilename = getOutFilename(filename);
            string oleFilename = outFilename;

            // Attempt to unzip as docm or xlsm OpenXML format
            try
            {
                orgFilename = getOrgFilename(filename);
                orgfileName = Path.GetDirectoryName(filename);
                unzipTempPath = CreateUniqueTempDirectory();
                File.Copy(filename, orgFilename);
                ZipFile.ExtractToDirectory(orgFilename, unzipTempPath);
                if (File.Exists(Path.Combine(unzipTempPath, "word", "vbaProject.bin")))
                {
                    oleFilename = Path.Combine(unzipTempPath, "word", "vbaProject.bin");
                }
                else if (File.Exists(Path.Combine(unzipTempPath, "xl", "vbaProject.bin")))
                {
                    oleFilename = Path.Combine(unzipTempPath, "xl", "vbaProject.bin");
                }
                is_OpenXML = true;
            }
            catch (Exception)
            {
                // Not OpenXML format, Maybe 97-2003 format, Make a copy
                if (File.Exists(outFilename)) File.Delete(outFilename);
                if (File.Exists(orgFilename)) File.Delete(orgFilename);

                File.Copy(filename, outFilename);
            }

            // Open OLE compound file for editing
            try
            {
                cf = new CompoundFile(oleFilename, CFSUpdateMode.Update, 0);
            }
            catch (Exception)
            {
                return false;
            }

            // Read relevant streams
            CFStorage commonStorage = cf.RootStorage; // docm or xlsm

            if (cf.RootStorage.TryGetStorage("Macros") != null)
                commonStorage = cf.RootStorage.GetStorage("Macros"); // .doc

            if (cf.RootStorage.TryGetStorage("_VBA_PROJECT_CUR") != null)
                commonStorage = cf.RootStorage.GetStorage("_VBA_PROJECT_CUR"); // xls	

            // maybe shoud think for rollback to 070719, remove if
            if(cf.RootStorage.TryGetStorage("VBA") != null)
            {
                vbaProjectStream = commonStorage.GetStorage("VBA").GetStream("_VBA_PROJECT").GetData();
                dirStream = Decompress(commonStorage.GetStorage("VBA").GetStream("dir").GetData());
            }

            if (cf.RootStorage.TryGetStream("project") != null)
                projectStream = commonStorage.GetStream("project").GetData();



            // Read project stream as string
            string projectStreamString = System.Text.Encoding.UTF8.GetString(projectStream);

            // Find all VBA modules in current file
            List<ModuleInformation> vbaModules = ParseModulesFromDirStream(dirStream);

            List<RootModuleInformation> rootModules = ParseModulesFromRoot(cf);

            if (findBlacklistApiUsage)
            {
                byte[] streamBytes;
                string vbaStringCode;
                foreach (var vbaModule in vbaModules)
                {
                    streamBytes = commonStorage.GetStorage("VBA").GetStream(vbaModule.orgModuleName).GetData();
                    vbaStringCode = GetVBATextFromModuleStream(streamBytes, vbaModule.textOffset);
                    using (var reader = new StringReader(vbaStringCode))
                    {
                        for (string line = reader.ReadLine(); line != null; line = reader.ReadLine())
                        {
                            if (blacklistCheck(line))
                            {
                                lastReport = true;
                                Infos.blaclistApi = true;
                            }
                        }
                    }

                }
            }


            if (findHideInGUI)
            {
                foreach (var vbaModule in vbaModules)
                {
                    if ((vbaModule.moduleName != "ThisDocument") && (vbaModule.moduleName != "ThisWorkbook"))
                    {
                        if (!projectStreamString.Contains("Module=" + vbaModule.moduleName))
                        {
                            lastReport = true;
                            Infos.guiHide = true;
                        }
                        else
                        {
                            Infos.guiHide = false;
                        }
                    }
                }
            }

            if (findUnviewableVBA)
            {
                if (Regex.IsMatch(projectStreamString, "CMG=\"\"") || Regex.IsMatch(projectStreamString, "GC=\"\""))
                {
                    lastReport = true;
                    Infos.unViewable = true;
                }
                else
                {
                    Infos.unViewable = false;
                }

            }

            if (findRandomName)
            {
                foreach (var vbaModule in vbaModules)
                {
                    if (vbaModule.orgModuleName != vbaModule.moduleName)
                    {
                        lastReport = true;
                        Infos.randomName = true;
                    }
                    else
                    {
                        Infos.randomName = false;
                    }
                }
            }

            if (Infos.blaclistApi || Infos.guiHide || Infos.randomName || Infos.unViewable)
            {
                byte[] streamBytes = { };

                foreach (var vbaModule in vbaModules)
                {
                    if (cf.RootStorage.TryGetStorage("Macros") != null)
                        streamBytes = cf.RootStorage.GetStorage("Macros").GetStorage("VBA").GetStream(vbaModule.moduleName).GetData();
                    else if (cf.RootStorage.TryGetStorage("_VBA_PROJECT_CUR") != null)
                        cf.RootStorage.GetStorage("_VBA_PROJECT_CUR").GetStorage("VBA").GetStream(vbaModule.moduleName).GetData(); // xls
                    else
                        streamBytes = commonStorage.GetStorage("VBA").GetStream(vbaModule.moduleName).GetData();

                    if (ExportMacroStrings(vbaModule.moduleName, GetVBATextFromModuleStream(streamBytes, vbaModule.textOffset)))
                    {
                        Infos.exportMacro = true;
                    }
                    else
                    {
                        Infos.exportMacro = false;
                    }
                        
                }
            }

            // Commit changes and close file
            cf.Commit();
            cf.Close();

            // Purge unused space in file
            CompoundFile.ShrinkCompoundFile(oleFilename);

            // Zip the file back up as a docm or xlsm
            if (is_OpenXML)
            {
                if (File.Exists(outFilename))
                    File.Delete(outFilename);
                if (File.Exists(orgFilename))
                    File.Delete(orgFilename);
                ZipFile.CreateFromDirectory(unzipTempPath, outFilename);
                // Delete Temporary Files
                Directory.Delete(unzipTempPath, true);
            }
            if (File.Exists(outFilename)) File.Delete(outFilename);
            if (File.Exists(orgFilename)) File.Delete(orgFilename);
            return lastReport;
        }

        private static string getOutFilename(String filename)
        {
            string fn = Path.GetFileNameWithoutExtension(filename);
            string ext = Path.GetExtension(filename);
            string path = Path.GetDirectoryName(filename);
            return Path.Combine(path, fn + "_Sample" + ext);
        }
        private static string getOrgFilename(String filename)
        {
            string fn = Path.GetFileNameWithoutExtension(filename);
            string ext = Path.GetExtension(filename);
            string path = Path.GetDirectoryName(filename);
            return Path.Combine(path, fn + "_Orginal" + ext);
        }

        private static string CreateUniqueTempDirectory()
        {
            var uniqueTempDir = Path.GetFullPath(Path.Combine(AppDomain.CurrentDomain.BaseDirectory, Guid.NewGuid().ToString()));
            Directory.CreateDirectory(uniqueTempDir);
            return uniqueTempDir;
        }


        private static byte[] ReplaceOfficeVersionInVBAProject(byte[] moduleStream, string officeVersion)
        {
            byte[] version = new byte[2];

            switch (officeVersion)
            {
                case "2010x86":
                    version[0] = 0x97;
                    version[1] = 0x00;
                    break;
                case "2013x86":
                    version[0] = 0xA3;
                    version[1] = 0x00;
                    break;
                case "2016x86":
                    version[0] = 0xAF;
                    version[1] = 0x00;
                    break;
                case "2013x64":
                    version[0] = 0xA6;
                    version[1] = 0x00;
                    break;
                case "2016x64":
                    version[0] = 0xB2;
                    version[1] = 0x00;
                    break;
                case "2019x64":
                    version[0] = 0xB2;
                    version[1] = 0x00;
                    break;
                default:
                    // Console.WriteLine("ERROR: Incorrect MS Office version specified - skipping this step.");
                    return moduleStream;
            }

            // Console.WriteLine("Targeting pcode on Office version: " + officeVersion);

            moduleStream[2] = version[0];
            moduleStream[3] = version[1];

            return moduleStream;
        }

        private static bool blacklistCheck(string srcString)
        {
            string[] Blacklist;
            Blacklist = new string[10];

            Blacklist[0] = "OpenProcess";
            Blacklist[1] = "CreateProcess";
            Blacklist[2] = "shell";
            Blacklist[3] = "WriteProcessMemory";
            Blacklist[4] = "CreateRemoteThread";
            Blacklist[5] = "AdjustPrivilege";
            Blacklist[6] = "Example6";
            Blacklist[7] = "CreateThread";
            Blacklist[8] = "Example8";
            Blacklist[9] = "powershell";

            foreach (string blackList in Blacklist)
            {
                if (Regex.IsMatch(srcString, blackList))
                {
                    return true;
                }
            }
            return false;
        }

        private static byte[] ReplaceVBATextInModuleStream(byte[] moduleStream, UInt32 textOffset, string newVBACode)
        {
            return moduleStream.Take((int)textOffset).Concat(Compress(Encoding.UTF8.GetBytes(newVBACode))).ToArray();
        }

        private static string GetVBATextFromModuleStream(byte[] moduleStream, UInt32 textOffset)
        {
            string vbaModuleText = System.Text.Encoding.UTF8.GetString(Decompress(moduleStream.Skip((int)textOffset).ToArray()));

            return vbaModuleText;
        }

        private static bool ExportMacroStrings(string fileName, string content)
        {
            fileName = Path.Combine(orgfileName, fileName) + ".bas";
            try
            {
                if (File.Exists(fileName))
                {
                    File.Delete(fileName);
                }

                using (FileStream fs = File.Create(fileName))
                {
                    Byte[] title = new UTF8Encoding(true).GetBytes(content);
                    fs.Write(title, 0, title.Length);
                }
                return true;
            }
            catch (Exception)
            {
                return false;
            }
        }

        private static List<RootModuleInformation> ParseModulesFromRoot(CompoundFile cf)
        {
            List<RootModuleInformation> modules = new List<RootModuleInformation>();

            RootModuleInformation currentModule = new RootModuleInformation { moduleName = "" };
            Action<CFItem> va = delegate (CFItem item)
            {

                switch (item.Name)
                {
                    case "dir":
                        break;
                    case "_VBA_PROJECT":
                        break;
                    default:
                        Console.WriteLine(item.Name);
                        currentModule.moduleName = item.Name;
                        modules.Add(currentModule);
                        currentModule = new RootModuleInformation { moduleName = "" };
                        break;
                }
            };
            if (cf.RootStorage.TryGetStorage("Macros") != null)
                cf.RootStorage.GetStorage("Macros").GetStorage("VBA").VisitEntries(va, false);
            else if (cf.RootStorage.TryGetStorage("_VBA_PROJECT_CUR") != null)
                cf.RootStorage.GetStorage("_VBA_PROJECT_CUR").GetStorage("VBA").VisitEntries(va, false); // xls
            else
                cf.RootStorage.GetStorage("VBA").VisitEntries(va, false);

            return modules;
        }

        private static List<ModuleInformation> ParseModulesFromDirStream(byte[] dirStream)
        {
            // 2.3.4.2 dir Stream: Version Independent Project Information
            // https://msdn.microsoft.com/en-us/library/dd906362(v=office.12).aspx
            // Dir stream is ALWAYS in little endian

            List<ModuleInformation> modules = new List<ModuleInformation>();

            int offset = 0;
            UInt16 tag;
            UInt32 wLength;
            ModuleInformation currentModule = new ModuleInformation { moduleName = "", textOffset = 0 };

            while (offset < dirStream.Length)
            {
                tag = GetWord(dirStream, offset);
                wLength = GetDoubleWord(dirStream, offset + 2);

                // The following idiocy is because Microsoft can't stick to their own format specification - taken from Pcodedmp
                if (tag == 9)
                    wLength = 6;
                else if (tag == 3)
                    wLength = 2;

                switch (tag)
                {
                    case 25: // 2.3.4.2.3.2.1 MODULENAME Record
                        currentModule.orgModuleName = System.Text.Encoding.UTF8.GetString(dirStream, (int)offset + 6, (int)wLength);
                        break;
                    case 26: // 2.3.4.2.3.2.3 MODULESTREAMNAME Record
                        currentModule.moduleName = System.Text.Encoding.UTF8.GetString(dirStream, (int)offset + 6, (int)wLength);
                        break;
                    case 49: // 2.3.4.2.3.2.5 MODULEOFFSET Record
                        currentModule.textOffset = GetDoubleWord(dirStream, offset + 6);
                        modules.Add(currentModule);
                        currentModule = new ModuleInformation { moduleName = "", textOffset = 0 };
                        break;
                }

                offset += 6;
                offset += (int)wLength;
            }

            return modules;
        }

        private class ModuleInformation
        {
            public string moduleName; // Name of VBA module stream

            public string orgModuleName;

            public UInt32 textOffset; // Offset of VBA source code in VBA module stream
        }

        private class RootModuleInformation
        {
            public string moduleName;
        }


        private static UInt16 GetWord(byte[] buffer, int offset)
        {
            var rawBytes = new byte[2];
            Array.Copy(buffer, offset, rawBytes, 0, 2);
            return BitConverter.ToUInt16(rawBytes, 0);
        }

        private static UInt32 GetDoubleWord(byte[] buffer, int offset)
        {
            var rawBytes = new byte[4];
            Array.Copy(buffer, offset, rawBytes, 0, 4);
            return BitConverter.ToUInt32(rawBytes, 0);
        }

        private static byte[] Compress(byte[] data)
        {
            var buffer = new DecompressedBuffer(data);
            var container = new CompressedContainer(buffer);
            return container.SerializeData();
        }

        private static byte[] Decompress(byte[] data)
        {
            var container = new CompressedContainer(data);
            var buffer = new DecompressedBuffer(container);
            return buffer.Data;
        }
    }

}
